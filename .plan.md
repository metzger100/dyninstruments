# `.plan.md`: Extract Duplicated Helpers Into Shared Utilities (All Duplicate Warnings)

## Summary
This pass will eliminate every current `duplicate-functions` warning from `npm run check:patterns`, while preserving runtime rendering behavior.  
Scope includes widget, shared, and cluster duplicate helpers, dependency wiring, headers, tests, and docs/debt/quality updates.

## Function Migration Map

| Duplicate Group | Source Files Today | Shared Destination / Resolution |
|---|---|---|
| `norm360`, `norm180` | `cluster/mappers/ClusterMapperToolkit.js`, `shared/widget-kits/gauge/GaugeAngleMath.js` | Remove local toolkit implementations; use `GaugeAngleMath.norm360/norm180` |
| `mod` | `GaugeAngleMath.js`, `GaugeTickMath.js` | Keep canonical `GaugeAngleMath.mod`; consume it from `GaugeTickMath` |
| `valueToAngle`, `angleToValue` | `GaugeAngleMath.js`, `GaugeValueMath.js` | Keep `GaugeAngleMath` canonical; keep `GaugeValueMath` API but convert wrappers to non-declaration aliases to avoid duplicate declaration warning and preserve signature |
| `reachedEnd` | `GaugeTickMath.js`, `GaugeDialRenderer.js` | Extract shared helper `GaugeTickMath.isBeyondEnd(...)`; reuse in both paths |
| `extractNumberText` | 4 semicircle wrappers | Move to `GaugeValueMath.extractNumberText` |
| `buildHighEndSectors` | Speed + Temperature gauges | Move to `GaugeValueMath.buildHighEndSectors` |
| `buildLowEndSectors` | Depth + Voltage gauges | Move to `GaugeValueMath.buildLowEndSectors` with optional default thresholds for voltage |
| `formatSpeed/formatSpeedString` | Speed + WindDial | Move to `GaugeValueMath.formatSpeedString` |
| `formatAngle180/formatDirection360` | WindDial + Compass | Move to `GaugeValueMath.formatAngle180` and `GaugeValueMath.formatDirection360` |
| `clamp` | `GaugeValueMath`, Position, ThreeValue | Remove widget-local clamps; use `GaugeValueMath.clamp` |
| `setFont`, `drawDisconnectOverlay` | `GaugeTextLayout`, Position, ThreeValue | Remove widget-local text helpers; use `GaugeTextLayout` |
| `fitSingleTextPx` | Position + ThreeValue | Add `GaugeTextLayout.fitSingleTextPx` (verbatim logic); use from both widgets |

## Files To Modify

- `shared/widget-kits/gauge/GaugeAngleMath.js`
- `shared/widget-kits/gauge/GaugeTickMath.js`
- `shared/widget-kits/gauge/GaugeDialRenderer.js`
- `shared/widget-kits/gauge/GaugeValueMath.js`
- `shared/widget-kits/gauge/GaugeTextLayout.js`
- `cluster/mappers/ClusterMapperToolkit.js`
- `widgets/gauges/SpeedGaugeWidget/SpeedGaugeWidget.js`
- `widgets/gauges/TemperatureGaugeWidget/TemperatureGaugeWidget.js`
- `widgets/gauges/DepthGaugeWidget/DepthGaugeWidget.js`
- `widgets/gauges/VoltageGaugeWidget/VoltageGaugeWidget.js`
- `widgets/gauges/WindDialWidget/WindDialWidget.js`
- `widgets/gauges/CompassGaugeWidget/CompassGaugeWidget.js`
- `widgets/text/ThreeValueTextWidget/ThreeValueTextWidget.js`
- `widgets/text/PositionCoordinateWidget/PositionCoordinateWidget.js`
- `config/components.js`
- `tests/shared/gauge/GaugeValueMath.test.js`
- `tests/shared/gauge/GaugeTickMath.test.js`
- `tests/cluster/mappers/ClusterMapperToolkit.test.js`
- `tests/widgets/gauges/SpeedGaugeWidget.test.js`
- `tests/widgets/gauges/TemperatureGaugeWidget.test.js`
- `tests/widgets/gauges/DepthGaugeWidget.test.js`
- `tests/widgets/gauges/VoltageGaugeWidget.test.js`
- `tests/widgets/text/PositionCoordinateWidget.test.js`
- `tests/config/components.test.js`
- `documentation/TECH-DEBT.md`
- `documentation/QUALITY.md`
- `documentation/conventions/coding-standards.md`
- `documentation/gauges/gauge-shared-api.md`
- `documentation/architecture/component-system.md`
- `documentation/architecture/cluster-widget-system.md`
- `documentation/widgets/semicircle-gauges.md`
- `documentation/widgets/wind-dial.md`
- `documentation/widgets/compass-gauge.md`
- `documentation/widgets/three-elements.md`
- `documentation/widgets/position-coordinates.md`

## `config/components.js` Dependency Changes

- `GaugeTickMath.deps`: add `["GaugeAngleMath"]`
- `ClusterMapperToolkit.deps`: add `["GaugeAngleMath"]`
- `SpeedGaugeWidget.deps`: add `"GaugeValueMath"` (keep `"SemicircleGaugeEngine"`)
- `DepthGaugeWidget.deps`: add `"GaugeValueMath"` (keep `"SemicircleGaugeEngine"`)
- `TemperatureGaugeWidget.deps`: add `"GaugeValueMath"` (keep `"SemicircleGaugeEngine"`)
- `VoltageGaugeWidget.deps`: add `"GaugeValueMath"` (keep `"SemicircleGaugeEngine"`)
- `ThreeValueTextWidget.deps`: add `["GaugeTextLayout", "GaugeValueMath"]`
- `PositionCoordinateWidget.deps`: replace `["ThreeValueTextWidget"]` with `["GaugeTextLayout", "GaugeValueMath"]`

## Ordered Implementation Steps (with required early regression checks)

1. Create `.plan.md` at repo root with this exact plan content.
2. Extract `mod` to canonical usage (`GaugeAngleMath` export + `GaugeTickMath` consumer), update headers/deps, run `npm test`.
3. Extract `isBeyondEnd` into `GaugeTickMath`, consume in `GaugeDialRenderer`, run `npm test`.
4. Remove `ClusterMapperToolkit` local `norm360/norm180`, consume `GaugeAngleMath`, run `npm test`.
5. Add `GaugeValueMath.extractNumberText`, switch four semicircle wrappers, run `npm test`.
6. Add `GaugeValueMath.buildHighEndSectors`, switch Speed/Temperature wrappers, run `npm test`.
7. Add `GaugeValueMath.buildLowEndSectors`, switch Depth/Voltage wrappers (preserve voltage defaults), run `npm test`.
8. Add `GaugeValueMath.formatSpeedString`, switch Speed/WindDial, run `npm test`.
9. Add `GaugeValueMath.formatAngle180` + `formatDirection360`, switch WindDial/Compass, run `npm test`.
10. Add `GaugeTextLayout.fitSingleTextPx`, switch ThreeValue/Position, run `npm test`.
11. Remove widget-local `setFont`, `drawDisconnectOverlay`, `clamp`, and mode duplication in ThreeValue/Position using shared APIs, run `npm test`.
12. Remove `PositionCoordinateWidget -> ThreeValueTextWidget` delegation by using shared text rendering path in flat mode, run `npm test`.
13. Resolve remaining `valueToAngle/angleToValue` duplicate declaration warning in `GaugeValueMath` while preserving public API shape, run `npm test`.
14. Update docs, TECH-DEBT, QUALITY, headers, and component dependency docs.
15. Final gates: `npm run check:all && npm test`.

## Test Impact Assessment

- Existing tests to update for new `Helpers.getModule(...)` requirements:
  - `tests/widgets/gauges/*.test.js`
  - `tests/widgets/text/PositionCoordinateWidget.test.js`
  - `tests/cluster/mappers/ClusterMapperToolkit.test.js`
- Shared utility tests to expand:
  - `tests/shared/gauge/GaugeValueMath.test.js` for new helper APIs
  - `tests/shared/gauge/GaugeTickMath.test.js` for `isBeyondEnd`
- Dependency wiring assertions:
  - `tests/config/components.test.js` for new deps and removed widget-to-widget dependency.
- Acceptance scenarios:
  - Sector outputs unchanged (speed/temp high-end, depth/voltage low-end).
  - Speed/angle formatting outputs unchanged.
  - Position flat mode output preserved without ThreeValue delegation.
  - `npm run check:deps` passes.
  - `node tools/check-patterns.mjs --warn` reports `duplicate-functions: 0`.
  - `GaugeValueMath.js` non-empty lines remain `< 300`.

## TECH-DEBT / QUALITY Updates

- Move completed duplicate-related topics from Active to Completed in `documentation/TECH-DEBT.md` with date `2026-02-20`:
  - TD-001, TD-002, TD-003, TD-004, TD-005, TD-006, TD-007, TD-010
- Keep unrelated open topics active:
  - TD-008, TD-009
- Update `documentation/QUALITY.md`:
  - Remove duplicate-helper drift rows that are fixed.
  - Update layer duplicate columns accordingly.
  - Adjust grades to reflect duplicate cleanup and dependency-direction fix.

## Public API / Interface Additions

- `GaugeAngleMath`: expose `mod`
- `GaugeTickMath`: add `isBeyondEnd`
- `GaugeValueMath`: add `extractNumberText`, `formatSpeedString`, `buildHighEndSectors`, `buildLowEndSectors`, `formatAngle180`, `formatDirection360`
- `GaugeTextLayout`: add `fitSingleTextPx`
- `config/components.js`: dependency graph updates listed above

## Assumptions and Defaults

- “All duplicate warnings” means all current `duplicate-functions` findings from `npm run check:patterns` baseline on `2026-02-20`.
- External rendering output must remain unchanged; shared helpers are extracted verbatim from current implementations where behavior is sensitive.
- This pass does not attempt to close non-duplicate warnings (forbidden globals, empty catch) except where naturally reduced by extraction.
- No new documentation files are added, so `documentation/TABLEOFCONTENTS.md` does not require new entries.
